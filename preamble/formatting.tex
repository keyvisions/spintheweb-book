% Formatting definitions for the Spin the Web Book
% This file contains all formatting and style definitions

% Hyperlink setup
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    citecolor=green,
    pdftitle={Spin the Web},
    pdfauthor={Giancarlo Trevisan (\organization)},
    pdfsubject={Enterprise Web Portal Development},
    pdfkeywords={WBDL, Web Spinner, Web Portal, Enterprise Software Integrator, STW},
    bookmarks=true,
    bookmarksopen=true,
    bookmarksopenlevel=2
}

% Page headers and footers
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[LO]{\nouppercase{\rightmark}}
\fancyhead[RE]{\nouppercase{\leftmark}}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% Fix header height warning
\setlength{\headheight}{14pt}

% Chapter and section formatting
\usepackage{titlesec}
\titleformat{\chapter}[display]
    {\sffamily\bfseries\huge}{\chaptertitlename\ \thechapter}{18pt}{\sffamily\bfseries\Huge}
% Tighter chapter spacing: before=36pt, after=24pt
\titlespacing*{\chapter}{0pt}{36pt}{24pt}

% Sans-serif for section levels
\titleformat{\section}
    {\Needspace{4\baselineskip}\sffamily\bfseries\Large}{\thesection~}{0pt}{}
% Tighter spacing around section headings
\titlespacing*{\section}{0pt}{1.5ex plus .5ex minus .2ex}{1.0ex plus .2ex}
\titleformat{\subsection}
    {\Needspace{3\baselineskip}\sffamily\bfseries\large}{\thesubsection~}{0pt}{}
\titlespacing*{\subsection}{0pt}{1.25ex plus .5ex minus .2ex}{0.8ex plus .2ex}
\titleformat{\subsubsection}
    {\Needspace{3\baselineskip}\sffamily\bfseries\normalsize}{\thesubsubsection~}{0pt}{}
\titlespacing*{\subsubsection}{0pt}{1.0ex plus .3ex minus .2ex}{0.6ex plus .1ex}

% Line spacing
\onehalfspacing

% Paragraph formatting
\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5em}

% Avoid widows and orphans (single lines at page breaks)
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000

% Also disallow page breaks that would leave only 1–2 lines
% at the top (clubs) or bottom (widows) of a page (e-TeX primitives)
\clubpenalties 2 10000 10000
\widowpenalties 2 10000 10000

% Allow more flexibility in line breaking and page height to reduce sparse pages
\raggedbottom
\tolerance=2000
\setlength{\emergencystretch}{3em}

% Ensure microtype features that help compaction are active
\microtypesetup{protrusion=true,expansion=true}

% Float placement tuning to better fill pages
\setcounter{topnumber}{3}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\textfraction}{0.07}
\renewcommand{\floatpagefraction}{0.8}

% List formatting
\setlist{nosep}
\setlist[itemize]{leftmargin=1.5em}
\setlist[enumerate]{leftmargin=1.5em}

% Code listing colors and styles
\definecolor{codebackground}{RGB}{248,248,248}
\definecolor{codeborder}{RGB}{255,255,255}
\definecolor{commentcolor}{RGB}{106,153,85}
\definecolor{keywordcolor}{RGB}{86,156,214}
\definecolor{stringcolor}{RGB}{206,145,120}

% Listings configuration
% Enable UTF-8 characters commonly used in examples inside listings
\lstset{
        inputencoding=utf8,
        literate=
            {‹}{{\guilsinglleft}}1 {›}{{\guilsinglright}}1 % single guillemets
            {«}{{\guillemotleft}}1 {»}{{\guillemotright}}1 % double guillemets
            {“}{{\textquotedblleft}}1 {”}{{\textquotedblright}}1 % curly double quotes
            {‘}{{\textquoteleft}}1 {’}{{\textquoteright}}1 % curly single quotes/apostrophe
            {–}{{\textendash}}1 {—}{{\textemdash}}1 % en/em dashes
            {…}{{\ldots}}1 % ellipsis
            {°}{{\textdegree}}1 % degree symbol
            {€}{{\texteuro}}1 % euro sign
            {™}{{\texttrademark}}1 {®}{{\textregistered}}1 {©}{{\textcopyright}}1 % symbols
            {•}{{\textbullet}}1
}

% Define JavaScript language if not provided by listings on this TeX distro
% (Some MiKTeX setups lack JavaScript by default.)
\lstdefinelanguage{JavaScript}{
    morekeywords={break,case,catch,continue,debugger,default,delete,do,else,finally,for,function,if,in,instanceof,new,return,switch,this,throw,try,typeof,var,void,while,with,const,let,of,import,from,export,class,extends,super,static,yield,await,async,true,false,null,undefined},
    sensitive=true,
    morecomment=[l]{//},
    morecomment=[s]{/*}{*/},
    morestring=[b]',
    morestring=[b]",
}

% Define JSON language (based on JavaScript, strings highlighted)
\lstdefinelanguage{JSON}{
    basicstyle=\ttfamily\small,
    showstringspaces=false,
    morestring=[b]",
    stringstyle=\color{stringcolor},
    morecomment=[l]{//},
}

% Define JSON language style for listings
\lstdefinestyle{jsonstyle}{
    language=JavaScript, % Use JavaScript as a base for syntax
    morestring=[b]",
    stringstyle=\color{stringcolor},
    morekeywords={true,false,null,_id,type,name,slug,keywords,description,visibility,children,mainpage,langs,datasources,version,namespace,rules,role,visible,subtype,query,layout,options,connectionString,baseUrl},
    keywordstyle=\color{keywordcolor},
    showstringspaces=false,
    basicstyle=\ttfamily\small,
    upquote=true,
    tabsize=2,
    breaklines=true,
    breakatwhitespace=true,
    frame=single,
    backgroundcolor=\color{codebackground},
    rulecolor=\color{codeborder},
}

% Define WBLL language for listings (custom DSL used in this book)
% Highlights tokens (single-letter mnemonics), supports comments and single-quoted strings
\lstdefinelanguage{WBLL}{
    morekeywords={t,e,f,r,l,w,m,h},
    sensitive=true,
    morecomment=[l]{//},
    morecomment=[s]{/*}{*/},
    morestring=[b]',
}

% Optional: a compact style for inline WBLL code blocks
\lstdefinestyle{wball}{
    language=WBLL,
    basicstyle=\ttfamily\small,
    showstringspaces=false,
    upquote=true,
}

% Custom boxes for examples, notes, warnings
\newtcolorbox{examplebox}[1][]{
    colback=blue!5!white,
    colframe=blue!75!black,
    title=Example,
    #1
}

\newtcolorbox{notebox}[1][]{
    colback=green!5!white,
    colframe=green!75!black,
    title=Note,
    #1
}

\newtcolorbox{warningbox}[1][]{
    colback=red!5!white,
    colframe=red!75!black,
    title=Warning,
    #1
}

\newtcolorbox{tipbox}[1][]{
    colback=orange!5!white,
    colframe=orange!75!black,
    title=Tip,
    #1
}

% Figure and table captions
\usepackage{caption}
\captionsetup{
    font=small,
    labelfont=bf,
    format=hang,
    indention=0cm,
    margin=1cm
}

% Glossary style
\setglossarystyle{altlist}

\usepackage{upquote}

\lstset{
  upquote=true,
  showstringspaces=false,
  keepspaces=true,
  columns=fullflexible,
  % normalize curly quotes to straight quotes in listings
    literate={’}{{'}}1 {‘}{{'}}1 {“}{{"}}1 {”}{{"}}1 {€}{{\texteuro}}1
}

\lstset{
    frame=single,                % Draw a box around listings
    breaklines=true,             % Enable automatic line breaking
    breakatwhitespace=true,      % Prefer breaking at whitespace
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}, % Mark wrapped lines
    basicstyle=\ttfamily\small,  % Monospaced font, small size
    backgroundcolor=\color{codebackground},
    rulecolor=\color{codeborder},
    showstringspaces=false,
    tabsize=2,
    xleftmargin=1em,
    xrightmargin=1em,
    aboveskip=1em,
    belowskip=1em,
    captionpos=b
}
